---
// EnemyManager Component - Gloomhaven Enemy Tracker
// Professional dark fantasy design
import type { Translations } from '../i18n/translations';

interface Props {
  t: Translations;
}

const { t } = Astro.props;
---

<section class="enemy-manager">
  <!-- Section Header -->
  <div class="section-header">
    <div class="header-left">
      <div class="section-icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="8.5" cy="10" r="1.5" fill="currentColor"/>
          <circle cx="15.5" cy="10" r="1.5" fill="currentColor"/>
          <path d="M8 15c1.5 2 6.5 2 8 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="section-title-group">
        <h2 class="section-title">{t['em.title']}</h2>
        <p class="section-subtitle">{t['em.subtitle']}</p>
      </div>
    </div>

    <div class="header-right">
      <div class="quick-stats" id="quickStats">
        <div class="quick-stat">
          <span class="quick-stat-value" id="enemyCount">0</span>
          <span class="quick-stat-label">{t['em.enemies']}</span>
        </div>
        <div class="quick-stat-divider"></div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="totalHp">0</span>
          <span class="quick-stat-label">{t['em.totalHp']}</span>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn btn-danger" id="clearAllBtn" title={t['card.clearAll']} disabled>
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="btn-label">{t['em.clear']}</span>
        </button>
        <button class="btn btn-ghost" id="collapseAllBtn" title={t['em.collapse']} disabled>
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="btn-label">{t['em.collapse']}</span>
        </button>
        <button class="btn btn-primary" id="addEnemyBtn">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
          </svg>
          <span class="btn-label">{t['em.addEnemy']}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Enemies Container -->
  <div class="enemies-wrapper">
    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <div class="empty-illustration">
        <div class="empty-circle">
          <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="40" cy="40" r="35" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
            <path d="M25 35c2-4 7-6 15-6s13 2 15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="30" cy="30" r="3" fill="currentColor"/>
            <circle cx="50" cy="30" r="3" fill="currentColor"/>
            <path d="M30 50c3 4 8 5 10 5s7-1 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="empty-glow"></div>
      </div>
      <h3 class="empty-title">{t['em.empty.title']}</h3>
      <p class="empty-text">{t['em.empty.text']}</p>
      <button class="btn btn-primary btn-lg" id="emptyAddBtn">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
        <span>{t['em.empty.button']}</span>
      </button>
    </div>

    <!-- Enemies Grid -->
    <div class="enemies-grid" id="enemiesGrid"></div>
  </div>
</section>

<!-- Add Enemy Modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="modal-title-group">
        <h3 class="modal-title">{t['em.modal.title']}</h3>
        <p class="modal-subtitle">{t['em.modal.subtitle']}</p>
      </div>
      <button class="modal-close" id="closeModalBtn" aria-label={t['em.modal.close']}>
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <form class="modal-body" id="addEnemyForm">
      <div class="form-group">
        <label class="form-label" for="enemyName">
          <span class="label-icon">üìõ</span>
          {t['em.modal.name']}
        </label>
        <input
          type="text"
          id="enemyName"
          class="form-input"
          placeholder={t['em.modal.namePlaceholder']}
          autocomplete="off"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="enemyHealth">
          <span class="label-icon">‚ù§Ô∏è</span>
          {t['em.modal.health']}
        </label>
        <input type="number" id="enemyHealth" class="form-input" value="10" min="1" max="999" />
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">üë•</span>
          {t['em.modal.quantity']}
        </label>
        <div class="quantity-control">
          <button type="button" class="qty-btn" data-action="decrease" aria-label={t['em.modal.quantityDecrease']}>
            <svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
          </button>
          <div class="qty-display">
            <input type="number" id="enemyQuantity" class="qty-input" value="1" min="1" max="20" />
            <span class="qty-label">{t['em.modal.quantityLabel']}</span>
          </div>
          <button type="button" class="qty-btn" data-action="increase" aria-label={t['em.modal.quantityIncrease']}>
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
          </button>
        </div>
        <span class="form-hint">{t['em.modal.quantityHint']}</span>
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">üé≠</span>
          {t['em.modal.type']}
        </label>
        <div class="enemy-type-selector">
          <label class="type-option">
            <input type="radio" name="enemyType" value="normal" checked />
            <span class="type-card">
              <span class="type-icon">üë§</span>
              <span class="type-name">{t['type.normal']}</span>
            </span>
          </label>
          <label class="type-option">
            <input type="radio" name="enemyType" value="elite" />
            <span class="type-card elite">
              <span class="type-icon">‚≠ê</span>
              <span class="type-name">{t['type.elite']}</span>
            </span>
          </label>
          <label class="type-option">
            <input type="radio" name="enemyType" value="boss" />
            <span class="type-card boss">
              <span class="type-icon">üëë</span>
              <span class="type-name">{t['type.boss']}</span>
            </span>
          </label>
          <label class="type-option">
            <input type="radio" name="enemyType" value="objective" />
            <span class="type-card objective">
              <span class="type-icon">üéØ</span>
              <span class="type-name">{t['type.objective']}</span>
            </span>
          </label>
        </div>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-ghost" id="cancelModalBtn">{t['em.modal.cancel']}</button>
      <button type="submit" class="btn btn-primary" id="confirmAddBtn">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>{t['em.modal.confirm']}</span>
      </button>
    </div>
  </div>
</div>

<!-- Enemy Card Template -->
<template id="enemyCardTemplate">
  <article class="enemy-card" data-enemy-id="" data-enemy-type="normal">
    <!-- Card Frame -->
    <div class="card-frame">
      <!-- Card Header -->
      <header class="card-header">
        <div class="drag-handle" title={t['card.drag']}>
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="9" cy="5" r="1.5" fill="currentColor"/>
            <circle cx="15" cy="5" r="1.5" fill="currentColor"/>
            <circle cx="9" cy="12" r="1.5" fill="currentColor"/>
            <circle cx="15" cy="12" r="1.5" fill="currentColor"/>
            <circle cx="9" cy="19" r="1.5" fill="currentColor"/>
            <circle cx="15" cy="19" r="1.5" fill="currentColor"/>
          </svg>
        </div>
        <div class="enemy-badge">
          <input type="number" class="badge-input" value="1" min="1" max="99" aria-label={t['card.number']}/>
        </div>
        <div class="enemy-identity">
          <input type="text" class="enemy-name" placeholder={t['card.namePlaceholder']} aria-label={t['card.name']}/>
          <div class="enemy-type-badge">
            <span class="type-text">{t['type.normal']}</span>
          </div>
        </div>
        <div class="card-controls">
          <button class="ctrl-btn ctrl-collapse" data-action="collapse" aria-label={t['card.collapse']}>
            <svg viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button class="ctrl-btn ctrl-duplicate" data-action="duplicate" aria-label={t['card.duplicate']}>
            <svg viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" stroke-width="2"/></svg>
          </button>
          <button class="ctrl-btn ctrl-delete" data-action="delete" aria-label={t['card.delete']}>
            <svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </header>

      <!-- Health Bar (Always visible) -->
      <div class="health-bar-container">
        <div class="health-bar-track">
          <div class="health-bar-fill"></div>
          <div class="health-bar-glow"></div>
        </div>
      </div>

      <!-- Card Body -->
      <div class="card-body">
        <!-- Health Controls -->
        <div class="health-section">
          <div class="health-label">{t['card.hp']}</div>
          <div class="health-controls">
            <div class="health-display">
              <span class="health-current">10</span>
              <span class="health-divider">/</span>
              <input type="number" class="health-max" value="10" min="1" max="999" aria-label={t['card.hpMax']}/>
            </div>
            <div class="health-buttons-row">
              <div class="damage-controls">
                <button class="health-btn damage-btn" data-amount="-5" aria-label={`-5 ${t['js.hpAria']}`}>-5</button>
                <button class="health-btn damage-btn" data-amount="-2" aria-label={`-2 ${t['js.hpAria']}`}>-2</button>
                <button class="health-btn damage-btn" data-amount="-1" aria-label={`-1 ${t['js.hpAria']}`}>-1</button>
              </div>
              <div class="heal-controls">
                <button class="health-btn heal-btn" data-amount="1" aria-label={`+1 ${t['js.hpAria']}`}>+1</button>
                <button class="health-btn heal-btn" data-amount="2" aria-label={`+2 ${t['js.hpAria']}`}>+2</button>
                <button class="health-btn heal-btn" data-amount="5" aria-label={`+5 ${t['js.hpAria']}`}>+5</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Divider -->
        <div class="section-divider">
          <span class="divider-line"></span>
          <span class="divider-icon">‚óÜ</span>
          <span class="divider-line"></span>
        </div>

        <!-- Status Effects -->
        <div class="status-section">
          <div class="status-group">
            <div class="status-header negative">
              <span class="status-header-icon">‚ö†Ô∏è</span>
              <span class="status-header-text">{t['status.negative']}</span>
            </div>
            <div class="status-grid">
              <button class="status-btn" data-status="poison" title={t['status.poison.desc']}>
                <span class="status-emoji">‚ò†Ô∏è</span>
                <span class="status-name">{t['status.poison']}</span>
              </button>
              <button class="status-btn" data-status="wound" title={t['status.wound.desc']}>
                <span class="status-emoji">ü©∏</span>
                <span class="status-name">{t['status.wound']}</span>
              </button>
              <button class="status-btn" data-status="immobilize" title={t['status.immobilize.desc']}>
                <span class="status-emoji">‚õìÔ∏è</span>
                <span class="status-name">{t['status.immobilize']}</span>
              </button>
              <button class="status-btn" data-status="disarm" title={t['status.disarm.desc']}>
                <span class="status-emoji">üö´</span>
                <span class="status-name">{t['status.disarm']}</span>
              </button>
              <button class="status-btn" data-status="stun" title={t['status.stun.desc']}>
                <span class="status-emoji">üí´</span>
                <span class="status-name">{t['status.stun']}</span>
              </button>
              <button class="status-btn" data-status="muddle" title={t['status.muddle.desc']}>
                <span class="status-emoji">üåÄ</span>
                <span class="status-name">{t['status.muddle']}</span>
              </button>
            </div>
          </div>

          <div class="status-group">
            <div class="status-header positive">
              <span class="status-header-icon">‚ú®</span>
              <span class="status-header-text">{t['status.positive']}</span>
            </div>
            <div class="status-grid positive-grid">
              <button class="status-btn positive" data-status="strengthen" title={t['status.strengthen.desc']}>
                <span class="status-emoji">üí™</span>
                <span class="status-name">{t['status.strengthen']}</span>
              </button>
              <button class="status-btn positive" data-status="shield" title={t['status.shield.desc']}>
                <span class="status-emoji">üõ°Ô∏è</span>
                <span class="status-name">{t['status.shield']}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>
</template>

<script>
  // ========================================
  // I18N
  // ========================================
  const i18nEl = document.getElementById('i18n-data');
  const i18n = i18nEl ? JSON.parse(i18nEl.textContent || '{}') : {};

  // ========================================
  // STATE
  // ========================================
  interface EnemyState {
    id: string;
    name: string;
    number: number;
    type: 'normal' | 'elite' | 'boss' | 'objective';
    currentHp: number;
    maxHp: number;
    statuses: Set<string>;
    collapsed: boolean;
  }

  const enemies = new Map<string, EnemyState>();
  let idCounter = 0;
  let manualOrder = false;
  let draggedCard: HTMLElement | null = null;

  // ========================================
  // DOM REFERENCES
  // ========================================
  const grid = document.getElementById('enemiesGrid')!;
  const emptyState = document.getElementById('emptyState')!;
  const modal = document.getElementById('addModal')!;
  const template = document.getElementById('enemyCardTemplate') as HTMLTemplateElement;
  const clearBtn = document.getElementById('clearAllBtn') as HTMLButtonElement;
  const collapseAllBtn = document.getElementById('collapseAllBtn') as HTMLButtonElement;

  // Stats
  const enemyCountEl = document.getElementById('enemyCount')!;
  const totalHpEl = document.getElementById('totalHp')!;

  // Form
  const nameInput = document.getElementById('enemyName') as HTMLInputElement;
  const healthInput = document.getElementById('enemyHealth') as HTMLInputElement;
  const quantityInput = document.getElementById('enemyQuantity') as HTMLInputElement;

  // ========================================
  // MODAL FUNCTIONS
  // ========================================
  function openModal() {
    modal.classList.add('active');
    nameInput.focus();
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    // Reset form
    (document.getElementById('addEnemyForm') as HTMLFormElement).reset();
    quantityInput.value = '1';
  }

  // Modal triggers
  document.getElementById('addEnemyBtn')?.addEventListener('click', openModal);
  document.getElementById('emptyAddBtn')?.addEventListener('click', openModal);
  document.getElementById('closeModalBtn')?.addEventListener('click', closeModal);
  document.getElementById('cancelModalBtn')?.addEventListener('click', closeModal);

  // Close on backdrop click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
  });

  // Quantity buttons
  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const action = (btn as HTMLElement).dataset.action;
      let val = parseInt(quantityInput.value) || 1;
      if (action === 'increase' && val < 20) val++;
      if (action === 'decrease' && val > 1) val--;
      quantityInput.value = val.toString();
    });
  });

  // ========================================
  // ENEMY MANAGEMENT
  // ========================================
  function generateId(): string {
    return `enemy-${Date.now()}-${++idCounter}`;
  }

  function createEnemy(name: string, number: number, maxHp: number, type: 'normal' | 'elite' | 'boss' | 'objective'): HTMLElement {
    const id = generateId();
    const state: EnemyState = {
      id,
      name,
      number,
      type,
      currentHp: maxHp,
      maxHp,
      statuses: new Set(),
      collapsed: false
    };
    enemies.set(id, state);

    const clone = template.content.cloneNode(true) as DocumentFragment;
    const card = clone.querySelector('.enemy-card') as HTMLElement;

    card.dataset.enemyId = id;
    card.dataset.enemyType = type;

    // Set values
    (card.querySelector('.badge-input') as HTMLInputElement).value = number.toString();
    (card.querySelector('.enemy-name') as HTMLInputElement).value = name;
    (card.querySelector('.health-current') as HTMLElement).textContent = maxHp.toString();
    (card.querySelector('.health-max') as HTMLInputElement).value = maxHp.toString();

    // Set type badge
    const typeBadge = card.querySelector('.enemy-type-badge .type-text') as HTMLElement;
    const typeLabels: Record<string, string> = {
      elite: i18n['type.elite'] || 'Elite',
      boss: i18n['type.boss'] || 'Boss',
      objective: i18n['type.objective'] || 'Objective',
      normal: i18n['type.normal'] || 'Normal'
    };
    typeBadge.textContent = typeLabels[type] || 'Normal';

    // Hide status section for objective type
    if (type === 'objective') {
      const statusSection = card.querySelector('.status-section') as HTMLElement;
      const divider = card.querySelector('.section-divider') as HTMLElement;
      if (statusSection) statusSection.style.display = 'none';
      if (divider) divider.style.display = 'none';
    }

    setupCardEvents(card, id);
    updateHealthBar(card, state);

    // Compact cards setting
    if (getSettings().compactCards) {
      state.collapsed = true;
      card.classList.add('collapsed');
    }

    return card;
  }

  function setupCardEvents(card: HTMLElement, id: string) {
    const state = enemies.get(id);
    if (!state) return;

    // Name change
    card.querySelector('.enemy-name')?.addEventListener('input', (e) => {
      state.name = (e.target as HTMLInputElement).value;
    });

    // Number change
    card.querySelector('.badge-input')?.addEventListener('change', (e) => {
      state.number = parseInt((e.target as HTMLInputElement).value) || 1;
      sortEnemiesInGrid();
    });

    // Max HP change
    const maxHpInput = card.querySelector('.health-max') as HTMLInputElement;
    maxHpInput?.addEventListener('change', () => {
      state.maxHp = Math.max(1, parseInt(maxHpInput.value) || 1);
      if (state.currentHp > state.maxHp) {
        state.currentHp = state.maxHp;
        updateHealthDisplay(card, state);
      }
      updateHealthBar(card, state);
      updateGlobalStats();
    });

    // Health buttons
    card.querySelectorAll('.health-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const amount = parseInt((btn as HTMLElement).dataset.amount || '0');
        modifyHealth(card, id, amount);
      });
    });

    // Status buttons
    card.querySelectorAll('.status-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const status = (btn as HTMLElement).dataset.status!;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
          state.statuses.add(status);
        } else {
          state.statuses.delete(status);
        }
      });
    });

    // Control buttons
    card.querySelectorAll('.ctrl-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = (btn as HTMLElement).dataset.action;
        if (action === 'collapse') toggleCollapse(card, id);
        if (action === 'duplicate') duplicateEnemy(card, id);
        if (action === 'delete') deleteEnemy(card, id, false);
      });
    });

    // Drag events
    setupDragEvents(card);
  }

  function getSettings() {
    const root = document.documentElement;
    return {
      animations: root.dataset.animations !== 'off',
      confirmClear: root.dataset.confirmClear !== 'off',
      autoRemoveDead: root.dataset.autoRemoveDead !== 'off',
      compactCards: root.dataset.compactCards === 'on',
    };
  }

  function modifyHealth(card: HTMLElement, id: string, amount: number) {
    const state = enemies.get(id);
    if (!state) return;

    state.currentHp = Math.max(0, Math.min(state.maxHp, state.currentHp + amount));
    updateHealthDisplay(card, state);
    updateHealthBar(card, state);
    updateGlobalStats();

    // Death handling
    if (state.currentHp <= 0 && getSettings().autoRemoveDead) {
      deleteEnemy(card, id, true);
    }
  }

  function updateHealthDisplay(card: HTMLElement, state: EnemyState) {
    const currentEl = card.querySelector('.health-current') as HTMLElement;
    currentEl.textContent = state.currentHp.toString();

    // Color based on percentage
    const pct = (state.currentHp / state.maxHp) * 100;
    if (pct > 60) {
      currentEl.style.color = 'var(--gh-green-400)';
    } else if (pct > 30) {
      currentEl.style.color = 'var(--gh-gold-400)';
    } else {
      currentEl.style.color = 'var(--gh-red-400)';
    }
  }

  function updateHealthBar(card: HTMLElement, state: EnemyState) {
    const pct = (state.currentHp / state.maxHp) * 100;
    const fill = card.querySelector('.health-bar-fill') as HTMLElement;
    const glow = card.querySelector('.health-bar-glow') as HTMLElement;

    fill.style.width = `${pct}%`;

    if (pct > 60) {
      fill.style.background = 'linear-gradient(90deg, var(--gh-green-600) 0%, var(--gh-green-400) 100%)';
      glow.style.background = 'var(--gh-green-500)';
    } else if (pct > 30) {
      fill.style.background = 'linear-gradient(90deg, var(--gh-gold-600) 0%, var(--gh-gold-400) 100%)';
      glow.style.background = 'var(--gh-gold-500)';
    } else {
      fill.style.background = 'linear-gradient(90deg, var(--gh-red-700) 0%, var(--gh-red-400) 100%)';
      glow.style.background = 'var(--gh-red-500)';
    }
  }

  function toggleCollapse(card: HTMLElement, id: string) {
    const state = enemies.get(id);
    if (!state) return;

    state.collapsed = !state.collapsed;
    card.classList.toggle('collapsed', state.collapsed);
  }

  function findLowestAvailableNumber(name: string): number {
    const usedNumbers = new Set<number>();
    enemies.forEach(e => {
      if (e.name === name) usedNumbers.add(e.number);
    });
    let num = 1;
    while (usedNumbers.has(num)) num++;
    return num;
  }

  function sortEnemiesInGrid() {
    if (manualOrder) return;
    const cards = Array.from(grid.querySelectorAll('.enemy-card')) as HTMLElement[];
    cards.sort((a, b) => {
      const stateA = enemies.get(a.dataset.enemyId || '');
      const stateB = enemies.get(b.dataset.enemyId || '');
      if (!stateA || !stateB) return 0;
      // Sort by name first, then by number
      const nameCompare = stateA.name.localeCompare(stateB.name);
      if (nameCompare !== 0) return nameCompare;
      return stateA.number - stateB.number;
    });
    cards.forEach(card => grid.appendChild(card));
  }

  function duplicateEnemy(card: HTMLElement, id: string) {
    const state = enemies.get(id);
    if (!state) return;

    const newNum = findLowestAvailableNumber(state.name);
    const newCard = createEnemy(state.name, newNum, state.maxHp, state.type);
    grid.appendChild(newCard);
    sortEnemiesInGrid();
    updateUI();
  }

  function deleteEnemy(card: HTMLElement, id: string, isDeath: boolean) {
    const { animations } = getSettings();

    if (!animations) {
      enemies.delete(id);
      card.remove();
      sortEnemiesInGrid();
      updateUI();
      return;
    }

    if (isDeath) {
      card.classList.add('dying');
      setTimeout(() => {
        card.classList.add('dead');
        setTimeout(() => {
          enemies.delete(id);
          card.remove();
          sortEnemiesInGrid();
          updateUI();
        }, 400);
      }, 500);
    } else {
      card.classList.add('removing');
      setTimeout(() => {
        enemies.delete(id);
        card.remove();
        sortEnemiesInGrid();
        updateUI();
      }, 300);
    }
  }

  // ========================================
  // DRAG AND DROP
  // ========================================
  function setupDragEvents(card: HTMLElement) {
    const handle = card.querySelector('.drag-handle') as HTMLElement;
    if (!handle) return;

    // -- Desktop: HTML5 Drag and Drop --
    handle.addEventListener('mousedown', () => {
      card.setAttribute('draggable', 'true');
    });

    card.addEventListener('dragstart', (e) => {
      draggedCard = card;
      card.classList.add('dragging');
      e.dataTransfer!.effectAllowed = 'move';
      e.dataTransfer!.setData('text/plain', '');
    });

    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      card.removeAttribute('draggable');
      draggedCard = null;
      grid.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom');
      });
    });

    card.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (!draggedCard || draggedCard === card) return;
      e.dataTransfer!.dropEffect = 'move';
      const rect = card.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      card.classList.remove('drag-over-top', 'drag-over-bottom');
      if (e.clientY < midY) {
        card.classList.add('drag-over-top');
      } else {
        card.classList.add('drag-over-bottom');
      }
    });

    card.addEventListener('dragleave', () => {
      card.classList.remove('drag-over-top', 'drag-over-bottom');
    });

    card.addEventListener('drop', (e) => {
      e.preventDefault();
      card.classList.remove('drag-over-top', 'drag-over-bottom');
      if (!draggedCard || draggedCard === card) return;
      const rect = card.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      if (e.clientY < midY) {
        card.before(draggedCard);
      } else {
        card.after(draggedCard);
      }
      manualOrder = true;
    });

    // -- Mobile: Touch drag --
    let touchActive = false;
    let touchClone: HTMLElement | null = null;
    let touchOffsetX = 0;
    let touchOffsetY = 0;

    handle.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      touchActive = true;
      draggedCard = card;
      card.classList.add('dragging');

      const rect = card.getBoundingClientRect();
      touchOffsetX = touch.clientX - rect.left;
      touchOffsetY = touch.clientY - rect.top;

      touchClone = card.cloneNode(true) as HTMLElement;
      touchClone.classList.add('drag-clone');
      touchClone.style.position = 'fixed';
      touchClone.style.zIndex = '10000';
      touchClone.style.width = rect.width + 'px';
      touchClone.style.pointerEvents = 'none';
      touchClone.style.opacity = '0.85';
      touchClone.style.transform = 'rotate(1.5deg) scale(1.03)';
      touchClone.style.left = (touch.clientX - touchOffsetX) + 'px';
      touchClone.style.top = (touch.clientY - touchOffsetY) + 'px';
      document.body.appendChild(touchClone);
    }, { passive: false });

    handle.addEventListener('touchmove', (e) => {
      if (!touchActive || !touchClone) return;
      e.preventDefault();
      const touch = e.touches[0];
      touchClone.style.left = (touch.clientX - touchOffsetX) + 'px';
      touchClone.style.top = (touch.clientY - touchOffsetY) + 'px';

      // Clear previous indicators
      grid.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom');
      });

      // Find target card under touch point
      const allCards = Array.from(grid.querySelectorAll('.enemy-card')) as HTMLElement[];
      for (const target of allCards) {
        if (target === card) continue;
        const targetRect = target.getBoundingClientRect();
        if (touch.clientX >= targetRect.left && touch.clientX <= targetRect.right &&
            touch.clientY >= targetRect.top && touch.clientY <= targetRect.bottom) {
          const midY = targetRect.top + targetRect.height / 2;
          if (touch.clientY < midY) {
            target.classList.add('drag-over-top');
          } else {
            target.classList.add('drag-over-bottom');
          }
          break;
        }
      }
    }, { passive: false });

    const endTouchDrag = () => {
      if (!touchActive) return;

      const overTop = grid.querySelector('.drag-over-top') as HTMLElement | null;
      const overBottom = grid.querySelector('.drag-over-bottom') as HTMLElement | null;
      if (overTop) {
        overTop.before(card);
        manualOrder = true;
      } else if (overBottom) {
        overBottom.after(card);
        manualOrder = true;
      }

      grid.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom');
      });
      card.classList.remove('dragging');
      if (touchClone) {
        touchClone.remove();
        touchClone = null;
      }
      draggedCard = null;
      touchActive = false;
    };

    handle.addEventListener('touchend', endTouchDrag);
    handle.addEventListener('touchcancel', endTouchDrag);
  }

  // Clean up draggable attribute on mouseup
  document.addEventListener('mouseup', () => {
    grid.querySelectorAll('.enemy-card[draggable]').forEach(c => {
      c.removeAttribute('draggable');
    });
  });

  // ========================================
  // UI UPDATES
  // ========================================
  function updateGlobalStats() {
    let totalHp = 0;
    enemies.forEach(e => totalHp += e.currentHp);

    enemyCountEl.textContent = enemies.size.toString();
    totalHpEl.textContent = totalHp.toString();
  }

  function updateUI() {
    const hasEnemies = enemies.size > 0;
    emptyState.style.display = hasEnemies ? 'none' : 'flex';
    grid.style.display = hasEnemies ? 'grid' : 'none';
    clearBtn.disabled = !hasEnemies;
    collapseAllBtn.disabled = !hasEnemies;
    updateGlobalStats();
  }

  // Collapse / Expand all
  let allCollapsed = false;
  collapseAllBtn.addEventListener('click', () => {
    allCollapsed = !allCollapsed;
    const cards = grid.querySelectorAll('.enemy-card') as NodeListOf<HTMLElement>;
    cards.forEach(card => {
      const id = card.dataset.enemyId || '';
      const state = enemies.get(id);
      if (state) {
        state.collapsed = allCollapsed;
        card.classList.toggle('collapsed', allCollapsed);
      }
    });
    // Update button icon direction
    const svg = collapseAllBtn.querySelector('svg');
    if (svg) {
      svg.style.transform = allCollapsed ? 'rotate(-180deg)' : 'rotate(0deg)';
      svg.style.transition = 'transform 0.25s ease';
    }
    const label = collapseAllBtn.querySelector('.btn-label');
    if (label) label.textContent = allCollapsed ? (i18n['em.expand'] || 'Expand') : (i18n['em.collapse'] || 'Collapse');
  });

  // Clear all
  clearBtn.addEventListener('click', () => {
    const { confirmClear } = getSettings();
    if (confirmClear && !confirm(i18n['js.confirmClear'] || 'Remove all enemies from the battlefield?')) {
      return;
    }
    grid.innerHTML = '';
    enemies.clear();
    updateUI();
  });

  // ========================================
  // FORM SUBMISSION
  // ========================================
  document.getElementById('confirmAddBtn')?.addEventListener('click', (e) => {
    e.preventDefault();

    const name = nameInput.value.trim();
    if (!name) {
      nameInput.focus();
      return;
    }

    const hp = parseInt(healthInput.value) || 10;
    const qty = parseInt(quantityInput.value) || 1;
    const type = (document.querySelector('input[name="enemyType"]:checked') as HTMLInputElement)?.value as 'normal' | 'elite' | 'boss' | 'objective' || 'normal';

    for (let i = 0; i < qty; i++) {
      const num = findLowestAvailableNumber(name);
      const card = createEnemy(name, num, hp, type);
      grid.appendChild(card);
    }

    sortEnemiesInGrid();
    closeModal();
    updateUI();
  });

  // Enter key in form
  document.getElementById('addEnemyForm')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('confirmAddBtn')?.click();
    }
  });

  // Initial state
  updateUI();
</script>

<style>
  /* ==========================================
     SECTION STRUCTURE
     ========================================== */
  .enemy-manager {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  /* ==========================================
     SECTION HEADER
     ========================================== */
  .section-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, var(--gh-bg-medium) 0%, var(--gh-bg-dark) 100%);
    border: 1px solid var(--gh-border-default);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md), inset 0 1px 0 rgba(255,255,255,0.03);
  }

  @media (min-width: 768px) {
    .section-header {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .section-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: linear-gradient(145deg, var(--gh-bg-light) 0%, var(--gh-bg-medium) 100%);
    border: 1.5px solid var(--gh-gold-600);
    border-radius: var(--radius-md);
    color: var(--gh-gold-400);
    box-shadow:
      inset 0 1px 2px rgba(255,255,255,0.05),
      0 2px 8px rgba(0,0,0,0.3),
      0 0 12px rgba(184, 134, 42, 0.15);
  }

  .section-icon svg {
    width: 18px;
    height: 18px;
  }

  .section-title-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .section-title {
    font-family: var(--font-heading);
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--gh-text-primary);
    margin: 0;
    letter-spacing: 0.02em;
  }

  .section-subtitle {
    font-size: var(--text-sm);
    color: var(--gh-text-muted);
    margin: 0;
  }

  .header-right {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    align-items: stretch;
  }

  @media (min-width: 640px) {
    .header-right {
      flex-direction: row;
      align-items: center;
    }
  }

  /* Quick Stats */
  .quick-stats {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    background: var(--gh-bg-dark);
    border: 1px solid var(--gh-border-subtle);
    border-radius: var(--radius-md);
  }

  .quick-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .quick-stat-value {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--gh-gold-400);
    line-height: 1;
  }

  .quick-stat-label {
    font-size: var(--text-xs);
    color: var(--gh-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .quick-stat-divider {
    width: 1px;
    height: 24px;
    background: var(--gh-border-default);
  }

  /* Header Actions */
  .header-actions {
    display: flex;
    gap: var(--space-2);
  }

  /* ==========================================
     BUTTONS
     ========================================== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .btn svg {
    width: 14px;
    height: 14px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--gh-gold-600) 0%, var(--gh-gold-700) 100%);
    border-color: var(--gh-gold-500);
    color: var(--gh-text-dark);
    box-shadow: 0 4px 12px rgba(184, 134, 42, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, var(--gh-gold-500) 0%, var(--gh-gold-600) 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(184, 134, 42, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-danger {
    background: var(--gh-bg-light);
    border-color: var(--gh-border-default);
    color: var(--gh-text-secondary);
  }

  .btn-danger:hover:not(:disabled) {
    background: var(--gh-red-700);
    border-color: var(--gh-red-600);
    color: white;
    box-shadow: var(--shadow-glow-red);
  }

  .btn-danger:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .btn-ghost {
    background: transparent;
    border-color: var(--gh-border-default);
    color: var(--gh-text-secondary);
  }

  .btn-ghost:hover {
    background: var(--gh-bg-light);
    color: var(--gh-text-primary);
  }

  .btn-lg {
    padding: var(--space-3) var(--space-5);
    font-size: var(--text-sm);
  }

  .btn-lg svg {
    width: 16px;
    height: 16px;
  }

  @media (max-width: 480px) {
    .btn-label {
      display: none;
    }
    .btn {
      padding: var(--space-3);
    }
  }

  /* ==========================================
     ENEMIES CONTAINER
     ========================================== */
  .enemies-wrapper {
    min-height: 300px;
  }

  .enemies-grid {
    display: none;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
    gap: var(--space-3);
    justify-items: center;
  }

  .enemies-grid > * {
    width: 100%;
    max-width: 380px;
  }

  /* ==========================================
     EMPTY STATE
     ========================================== */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding: var(--space-8) var(--space-4);
    background: linear-gradient(180deg, var(--gh-bg-medium) 0%, var(--gh-bg-dark) 100%);
    border: 2px dashed var(--gh-border-default);
    border-radius: var(--radius-xl);
    text-align: center;
  }

  .empty-illustration {
    position: relative;
  }

  .empty-circle {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gh-text-muted);
  }

  .empty-circle svg {
    width: 100%;
    height: 100%;
  }

  .empty-glow {
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle, rgba(184, 134, 42, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    z-index: -1;
  }

  .empty-title {
    font-family: var(--font-heading);
    font-size: var(--text-base);
    color: var(--gh-text-primary);
    margin: 0;
  }

  .empty-text {
    font-size: var(--text-sm);
    color: var(--gh-text-muted);
    max-width: 350px;
    margin: 0;
    line-height: var(--leading-relaxed);
  }

  /* ==========================================
     MODAL
     ========================================== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .modal {
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    background: linear-gradient(180deg, var(--gh-bg-medium) 0%, var(--gh-bg-dark) 100%);
    border: 1px solid var(--gh-border-default);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl), 0 0 40px rgba(184, 134, 42, 0.1);
    transform: scale(0.9) translateY(20px);
    transition: transform var(--transition-slow);
  }

  .modal-overlay.active .modal {
    transform: scale(1) translateY(0);
  }

  .modal-header {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-4);
    border-bottom: 1px solid var(--gh-border-subtle);
    background: linear-gradient(180deg, rgba(184, 134, 42, 0.05) 0%, transparent 100%);
  }

  .modal-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--gh-gold-600) 0%, var(--gh-gold-700) 100%);
    border-radius: var(--radius-md);
    color: var(--gh-text-dark);
    flex-shrink: 0;
  }

  .modal-icon svg {
    width: 18px;
    height: 18px;
  }

  .modal-title-group {
    flex: 1;
  }

  .modal-title {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    color: var(--gh-text-primary);
    margin: 0 0 var(--space-1) 0;
  }

  .modal-subtitle {
    font-size: var(--text-sm);
    color: var(--gh-text-muted);
    margin: 0;
  }

  .modal-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: var(--gh-bg-light);
    border: 1px solid var(--gh-border-default);
    border-radius: var(--radius-sm);
    color: var(--gh-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--gh-red-700);
    border-color: var(--gh-red-600);
    color: white;
  }

  .modal-close svg {
    width: 16px;
    height: 16px;
  }

  .modal-body {
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border-top: 1px solid var(--gh-border-subtle);
    background: var(--gh-bg-dark);
  }

  /* ==========================================
     FORM ELEMENTS
     ========================================== */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  @media (max-width: 400px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .form-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--gh-text-secondary);
  }

  .label-icon {
    font-size: var(--text-base);
  }

  .form-input {
    padding: var(--space-2) var(--space-3);
    background: var(--gh-bg-darkest);
    border: 1.5px solid var(--gh-border-default);
    border-radius: var(--radius-sm);
    color: var(--gh-text-primary);
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
  }

  .form-input:hover {
    border-color: var(--gh-border-strong);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--gh-gold-500);
    box-shadow: 0 0 0 3px rgba(184, 134, 42, 0.2);
  }

  .form-input::placeholder {
    color: var(--gh-text-muted);
  }

  .form-hint {
    font-size: var(--text-xs);
    color: var(--gh-text-muted);
  }

  /* Quantity Control */
  .quantity-control {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    background: var(--gh-bg-darkest);
    border: 1.5px solid var(--gh-border-default);
    border-radius: var(--radius-sm);
    padding: var(--space-1);
  }

  .qty-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--gh-bg-light);
    border: 1px solid var(--gh-border-default);
    border-radius: var(--radius-sm);
    color: var(--gh-text-primary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .qty-btn:hover {
    background: var(--gh-gold-700);
    border-color: var(--gh-gold-600);
    color: var(--gh-gold-100);
  }

  .qty-btn svg {
    width: 16px;
    height: 16px;
  }

  .qty-display {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  .qty-input {
    width: 40px;
    background: transparent;
    border: none;
    color: var(--gh-gold-400);
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    text-align: center;
  }

  .qty-input:focus {
    outline: none;
  }

  .qty-label {
    font-size: var(--text-sm);
    color: var(--gh-text-muted);
  }

  /* Enemy Type Selector */
  .enemy-type-selector {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-2);
  }

  .type-option {
    cursor: pointer;
  }

  .type-option input {
    display: none;
  }

  .type-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2);
    background: var(--gh-bg-darkest);
    border: 1.5px solid var(--gh-border-default);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }

  .type-option input:checked + .type-card {
    border-color: var(--gh-purple-500);
    background: rgba(144, 97, 228, 0.1);
    box-shadow: 0 0 15px rgba(144, 97, 228, 0.2);
  }

  .type-card.elite {
    border-color: var(--gh-gold-600);
  }

  .type-option input:checked + .type-card.elite {
    border-color: var(--gh-gold-500);
    background: rgba(184, 134, 42, 0.1);
    box-shadow: 0 0 15px rgba(184, 134, 42, 0.2);
  }

  .type-card.boss {
    border-color: var(--gh-red-600);
  }

  .type-option input:checked + .type-card.boss {
    border-color: var(--gh-red-500);
    background: rgba(220, 69, 69, 0.1);
    box-shadow: 0 0 15px rgba(220, 69, 69, 0.2);
  }

  .type-card.objective {
    border-color: var(--gh-blue-600);
  }

  .type-option input:checked + .type-card.objective {
    border-color: var(--gh-blue-500);
    background: rgba(109, 184, 232, 0.1);
    box-shadow: 0 0 15px rgba(109, 184, 232, 0.2);
  }

  .type-icon {
    font-size: var(--text-lg);
  }

  .type-name {
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    color: var(--gh-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* ==========================================
     ENEMY CARD
     ========================================== */
  .enemy-card {
    animation: cardAppear 0.4s ease-out;
  }

  @keyframes cardAppear {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .enemy-card.dying {
    animation: cardDying 0.5s ease-out forwards;
  }

  @keyframes cardDying {
    0% { transform: scale(1); }
    30% { transform: scale(1.05); }
    100% { transform: scale(0.9); opacity: 0.3; filter: grayscale(1); }
  }

  .enemy-card.dead {
    animation: cardDead 0.4s ease-out forwards;
  }

  @keyframes cardDead {
    to {
      opacity: 0;
      transform: scale(0.8) translateY(-20px);
      max-height: 0;
      margin: 0;
      padding: 0;
    }
  }

  .enemy-card.removing {
    animation: cardRemove 0.3s ease-out forwards;
  }

  @keyframes cardRemove {
    to {
      opacity: 0;
      transform: scale(0.9);
    }
  }

  /* Card Frame */
  .card-frame {
    background: linear-gradient(180deg, var(--gh-bg-medium) 0%, var(--gh-bg-dark) 100%);
    border: 1.5px solid var(--gh-border-default);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
  }

  .enemy-card:hover .card-frame {
    border-color: var(--gh-purple-600);
    box-shadow: var(--shadow-xl), 0 0 30px rgba(144, 97, 228, 0.15);
  }

  /* Elite styling */
  .enemy-card[data-enemy-type="elite"] .card-frame {
    border-color: var(--gh-gold-600);
    background: linear-gradient(180deg, rgba(184, 134, 42, 0.15) 0%, var(--gh-bg-dark) 100%);
  }

  .enemy-card[data-enemy-type="elite"]:hover .card-frame {
    border-color: var(--gh-gold-500);
    box-shadow: var(--shadow-xl), 0 0 30px rgba(184, 134, 42, 0.2);
  }

  .enemy-card[data-enemy-type="elite"] .enemy-badge {
    background: linear-gradient(135deg, var(--gh-gold-600) 0%, var(--gh-gold-700) 100%);
    border-color: var(--gh-gold-500);
  }

  /* Boss styling */
  .enemy-card[data-enemy-type="boss"] .card-frame {
    border-color: var(--gh-red-600);
    background: linear-gradient(180deg, rgba(143, 34, 34, 0.15) 0%, var(--gh-bg-dark) 100%);
  }

  .enemy-card[data-enemy-type="boss"]:hover .card-frame {
    border-color: var(--gh-red-500);
    box-shadow: var(--shadow-xl), 0 0 30px rgba(220, 69, 69, 0.2);
  }

  .enemy-card[data-enemy-type="boss"] .enemy-badge {
    background: linear-gradient(135deg, var(--gh-red-600) 0%, var(--gh-red-700) 100%);
    border-color: var(--gh-red-500);
  }

  /* Objective styling */
  .enemy-card[data-enemy-type="objective"] .card-frame {
    border-color: var(--gh-blue-600);
    background: linear-gradient(180deg, rgba(109, 184, 232, 0.1) 0%, var(--gh-bg-dark) 100%);
  }

  .enemy-card[data-enemy-type="objective"]:hover .card-frame {
    border-color: var(--gh-blue-500);
    box-shadow: var(--shadow-xl), 0 0 30px rgba(109, 184, 232, 0.2);
  }

  .enemy-card[data-enemy-type="objective"] .enemy-badge {
    background: linear-gradient(135deg, var(--gh-blue-600) 0%, var(--gh-blue-700) 100%);
    border-color: var(--gh-blue-500);
  }

  .enemy-card[data-enemy-type="objective"] .type-text {
    color: var(--gh-blue-400);
  }

  /* Card Header */
  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
    border-bottom: 1px solid var(--gh-border-subtle);
  }

  .enemy-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--gh-purple-600) 0%, var(--gh-purple-700) 100%);
    border: 1.5px solid var(--gh-purple-500);
    border-radius: var(--radius-sm);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    flex-shrink: 0;
  }

  .badge-input {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--gh-text-dark);
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-weight: 700;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  .badge-input:focus {
    outline: none;
  }

  .enemy-identity {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .enemy-name {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid transparent;
    color: var(--gh-text-primary);
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    font-weight: 600;
    padding: 1px 0;
    transition: border-color var(--transition-fast);
  }

  .enemy-name:hover {
    border-bottom-color: var(--gh-border-default);
  }

  .enemy-name:focus {
    outline: none;
    border-bottom-color: var(--gh-gold-500);
  }

  .enemy-name::placeholder {
    color: var(--gh-text-muted);
  }

  .enemy-type-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px var(--space-2);
    background: var(--gh-bg-light);
    border-radius: var(--radius-sm);
    width: fit-content;
  }

  .type-text {
    font-size: 10px;
    font-weight: 600;
    color: var(--gh-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .enemy-card[data-enemy-type="elite"] .type-text {
    color: var(--gh-gold-400);
  }

  .enemy-card[data-enemy-type="boss"] .type-text {
    color: var(--gh-red-400);
  }

  /* Card Controls */
  .card-controls {
    display: flex;
    gap: 2px;
  }

  .ctrl-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--gh-bg-light);
    border: 1px solid var(--gh-border-subtle);
    border-radius: var(--radius-sm);
    color: var(--gh-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .ctrl-btn:hover {
    color: var(--gh-text-primary);
    background: var(--gh-bg-lighter);
  }

  .ctrl-btn svg {
    width: 14px;
    height: 14px;
    transition: transform var(--transition-base);
  }

  .ctrl-collapse svg {
    transform: rotate(0deg);
  }

  .enemy-card.collapsed .ctrl-collapse svg {
    transform: rotate(-180deg);
  }

  .ctrl-duplicate:hover {
    color: var(--gh-blue-400);
    border-color: var(--gh-blue-600);
    background: rgba(61, 156, 214, 0.1);
  }

  .ctrl-delete:hover {
    color: var(--gh-red-400);
    border-color: var(--gh-red-600);
    background: rgba(220, 69, 69, 0.1);
  }

  /* Health Bar */
  .health-bar-container {
    padding: 0 var(--space-3);
    background: var(--gh-bg-darkest);
  }

  .health-bar-track {
    position: relative;
    height: 5px;
    background: var(--gh-bg-light);
    border-radius: 3px;
    overflow: hidden;
  }

  .health-bar-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, var(--gh-green-600) 0%, var(--gh-green-400) 100%);
    border-radius: 3px;
    transition: width var(--transition-base), background var(--transition-base);
  }

  .health-bar-glow {
    position: absolute;
    top: 0;
    right: 0;
    width: 30px;
    height: 100%;
    background: var(--gh-green-500);
    filter: blur(8px);
    opacity: 0.5;
    transition: background var(--transition-base);
  }

  /* Card Body */
  .card-body {
    padding: var(--space-3);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    overflow: hidden;
    transition: all var(--transition-base);
  }

  .enemy-card.collapsed .card-body {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    opacity: 0;
  }

  /* Health Section */
  .health-section {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .health-label {
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--gh-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-align: center;
  }

  .health-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
  }

  .health-buttons-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  .damage-controls,
  .heal-controls {
    display: flex;
    gap: var(--space-1);
  }

  .health-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 30px;
    height: 28px;
    padding: 0 var(--space-1);
    border-radius: var(--radius-sm);
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .damage-btn {
    background: linear-gradient(135deg, var(--gh-red-600) 0%, var(--gh-red-700) 100%);
    border: 1px solid var(--gh-red-500);
    color: white;
  }

  .damage-btn:hover {
    background: linear-gradient(135deg, var(--gh-red-500) 0%, var(--gh-red-600) 100%);
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow-red);
  }

  .damage-btn:active {
    transform: translateY(0);
  }

  .heal-btn {
    background: linear-gradient(135deg, var(--gh-green-600) 0%, var(--gh-green-700) 100%);
    border: 1px solid var(--gh-green-500);
    color: white;
  }

  .heal-btn:hover {
    background: linear-gradient(135deg, var(--gh-green-500) 0%, var(--gh-green-600) 100%);
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow-green);
  }

  .heal-btn:active {
    transform: translateY(0);
  }

  .health-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2px;
    min-width: 80px;
    padding: var(--space-1) var(--space-3);
    background: var(--gh-bg-darkest);
    border: 1.5px solid var(--gh-border-default);
    border-radius: var(--radius-sm);
  }

  .health-current {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--gh-green-400);
    min-width: 28px;
    text-align: right;
    transition: color var(--transition-base);
  }

  .health-divider {
    font-size: var(--text-sm);
    color: var(--gh-text-muted);
  }

  .health-max {
    width: 38px;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--gh-border-default);
    color: var(--gh-text-secondary);
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    font-weight: 600;
    text-align: left;
    transition: border-color var(--transition-fast);
  }

  .health-max:focus {
    outline: none;
    border-bottom-color: var(--gh-gold-500);
  }

  /* Section Divider */
  .section-divider {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) 0;
  }

  .section-divider .divider-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--gh-border-default) 50%, transparent 100%);
  }

  .section-divider .divider-icon {
    color: var(--gh-gold-600);
    font-size: 8px;
  }

  /* Status Section */
  .status-section {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .status-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .status-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .status-header-icon {
    font-size: var(--text-sm);
  }

  .status-header-text {
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--gh-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .status-header.negative .status-header-text {
    color: var(--gh-red-400);
  }

  .status-header.positive .status-header-text {
    color: var(--gh-green-400);
  }

  .status-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-2);
  }

  .positive-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  @media (min-width: 480px) {
    .status-grid {
      grid-template-columns: repeat(6, 1fr);
    }
    .positive-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .status-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    padding: var(--space-1);
    background: var(--gh-bg-darkest);
    border: 1.5px solid var(--gh-border-subtle);
    border-radius: var(--radius-sm);
    cursor: pointer;
    opacity: 0.5;
    transition: all var(--transition-fast);
  }

  .status-btn:hover {
    opacity: 0.8;
    border-color: var(--gh-border-default);
    transform: translateY(-2px);
  }

  .status-btn.active {
    opacity: 1;
    border-color: var(--gh-red-500);
    background: rgba(220, 69, 69, 0.1);
    box-shadow: var(--shadow-glow-red);
  }

  .status-btn.positive.active {
    border-color: var(--gh-green-500);
    background: rgba(60, 185, 122, 0.1);
    box-shadow: var(--shadow-glow-green);
  }

  .status-emoji {
    font-size: var(--text-base);
    line-height: 1;
  }

  .status-name {
    font-family: var(--font-heading);
    font-size: 7px;
    font-weight: 600;
    color: var(--gh-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: center;
  }

  /* ==========================================
     DRAG AND DROP
     ========================================== */
  .drag-handle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 28px;
    color: var(--gh-text-muted);
    cursor: grab;
    opacity: 0.35;
    transition: all var(--transition-fast);
    flex-shrink: 0;
    touch-action: none;
  }

  .drag-handle:hover {
    opacity: 1;
    color: var(--gh-gold-400);
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .drag-handle svg {
    width: 14px;
    height: 14px;
  }

  .enemy-card.dragging {
    opacity: 0.3;
  }

  .enemy-card.dragging .card-frame {
    border-color: var(--gh-gold-500);
    border-style: dashed;
  }

  .enemy-card.drag-over-top,
  .enemy-card.drag-over-bottom {
    position: relative;
  }

  .enemy-card.drag-over-top::before {
    content: '';
    position: absolute;
    top: -3px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gh-gold-400);
    border-radius: 2px;
    z-index: 10;
    box-shadow: 0 0 10px var(--gh-gold-500);
  }

  .enemy-card.drag-over-bottom::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gh-gold-400);
    border-radius: 2px;
    z-index: 10;
    box-shadow: 0 0 10px var(--gh-gold-500);
  }

  .drag-clone .card-frame {
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(184, 134, 42, 0.3);
    border-color: var(--gh-gold-500);
  }

  /* ==========================================
     RESPONSIVE
     ========================================== */
  @media (max-width: 640px) {
    .section-header {
      padding: var(--space-3);
    }

    .section-icon {
      width: 30px;
      height: 30px;
    }

    .section-icon svg {
      width: 16px;
      height: 16px;
    }

    .section-title {
      font-size: var(--text-sm);
    }

    .quick-stats {
      display: none;
    }

    .enemy-badge {
      width: 28px;
      height: 28px;
    }

    .badge-input {
      font-size: var(--text-xs);
    }

    .card-body {
      padding: var(--space-2);
      gap: var(--space-2);
    }

    .health-btn {
      min-width: 28px;
      height: 26px;
      font-size: 0.6rem;
    }

    .health-display {
      min-width: 72px;
      padding: var(--space-1) var(--space-2);
    }

    .health-current {
      font-size: var(--text-base);
      min-width: 24px;
    }

    .status-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .positive-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .status-emoji {
      font-size: var(--text-sm);
    }

    .status-name {
      font-size: 6px;
    }

    .ctrl-btn {
      width: 24px;
      height: 24px;
    }

    .ctrl-btn svg {
      width: 12px;
      height: 12px;
    }
  }

  @media (max-width: 400px) {
    .health-controls {
      flex-direction: column;
      gap: var(--space-1);
    }

    .damage-controls,
    .heal-controls {
      width: 100%;
      justify-content: center;
    }

    .health-display {
      width: 100%;
      justify-content: center;
    }

    .status-name {
      display: none;
    }

    .status-btn {
      padding: var(--space-1);
    }

    .status-emoji {
      font-size: var(--text-base);
    }
  }

  /* Touch devices */
  @media (hover: none) and (pointer: coarse) {
    .health-btn {
      min-width: 36px;
      height: 34px;
    }

    .status-btn {
      padding: var(--space-2);
    }

    .ctrl-btn {
      width: 32px;
      height: 32px;
    }
  }
</style>
